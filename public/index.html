<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirexOTP - Virtual Numbers</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00f3ff;
            --secondary: #ff00e6;
            --accent: #7700ff;
            --success: #00ff9d;
            --danger: #ff0040;
            --warning: #ffd166;
            --info: #00a2ff;
            --dark: #0a0a12;
            --darker: #050508;
            --glass: rgba(255, 255, 255, 0.05);
            --glow: rgba(0, 243, 255, 0.3);
            --cyber-border: 1px solid rgba(0, 243, 255, 0.3);
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #0f0f1a 100%);
            color: white;
            min-height: 100vh;
            padding: 15px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Header Styles */
        header {
            text-align: center;
            padding: 25px 15px;
            margin-bottom: 25px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary);
        }

        .logo h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .tagline {
            font-size: 1rem;
            color: #c7d2fe;
            margin-bottom: 12px;
        }

        .service-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--success), var(--info));
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
            margin-top: 12px;
            border: var(--cyber-border);
        }

        /* Country Selector */
        .country-selector {
            margin-bottom: 25px;
        }

        .country-search {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: var(--cyber-border);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .selected-country {
            background: rgba(0, 243, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: var(--cyber-border);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selected-price {
            color: var(--success);
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Card Styles */
        .card {
            background: var(--glass);
            border-radius: 15px;
            padding: 25px 20px;
            backdrop-filter: blur(20px);
            border: var(--cyber-border);
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: var(--cyber-border);
        }

        .card-header i {
            font-size: 1.6rem;
            color: var(--primary);
        }

        .card-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: black;
            border: var(--cyber-border);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00c97a);
            color: black;
            border: var(--cyber-border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e6003c);
            color: white;
            border: var(--cyber-border);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Result Areas */
        .result-area {
            margin-top: 20px;
            padding: 25px 20px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            border: var(--cyber-border);
        }

        .result-area.active {
            display: block;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: var(--cyber-border);
        }

        .result-label {
            font-weight: 600;
            color: #c7d2fe;
        }

        .result-value {
            font-weight: 500;
            color: white;
        }

        /* Timer */
        .timer {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 25px 0;
            color: var(--warning);
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: var(--cyber-border);
            font-family: 'Courier New', monospace;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        /* Status Messages */
        .status-message {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: rgba(0, 255, 157, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-error {
            background: rgba(255, 0, 64, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auth Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 10, 14, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #0a0a12;
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* Profile */
        .corner-profile {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .profile-btn {
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .profile-dropdown {
            position: absolute;
            top: 70px;
            left: 0;
            background: #0a0a12;
            border: 2px solid var(--accent);
            border-radius: 15px;
            padding: 20px;
            min-width: 250px;
            display: none;
        }

        .profile-dropdown.active {
            display: block;
        }

        .profile-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .balance-amount {
            font-weight: bold;
            color: var(--success);
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-user-shield"></i>
                <h2>ACCESS PORTAL</h2>
                <p>Login to access OTP services</p>
            </div>
            
            <input type="email" id="authEmail" class="auth-input" placeholder="Email Address">
            <input type="password" id="authPassword" class="auth-input" placeholder="Password">
            
            <button id="signInBtn" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> LOGIN
            </button>
            
            <button id="signUpBtn" class="btn btn-success">
                <i class="fas fa-user-plus"></i> SIGN UP
            </button>
            
            <div id="authStatus" class="auth-status"></div>
        </div>
    </div>

    <!-- Profile Button -->
    <div class="corner-profile">
        <button class="profile-btn" id="profileBtn">
            <i class="fas fa-user"></i>
        </button>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-info">
                <div class="profile-email" id="profileEmail">user@example.com</div>
                <div class="profile-balance">
                    <i class="fas fa-wallet"></i>
                    <span>Balance: â‚¹</span>
                    <span class="balance-amount" id="profileBalance">0</span>
                </div>
            </div>
            <div class="profile-actions">
                <button class="btn btn-success" id="addBalanceProfileBtn">
                    <i class="fas fa-plus-circle"></i> Add Balance
                </button>
                <button class="btn btn-danger" id="logoutProfileBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-sim-card"></i>
                <h1>FirexOTP</h1>
            </div>
            <p class="tagline">Virtual Numbers for WhatsApp Verification</p>
            <div class="service-badge">
                <i class="fab fa-whatsapp"></i> WhatsApp Verification
            </div>
        </header>

        <!-- Country Selector -->
        <div class="country-selector">
            <div class="selected-country" id="selectedCountry">
                <div class="selected-info">
                    <span id="selectedFlag">ðŸ‡µðŸ‡­</span>
                    <span id="selectedName">WhatsApp Philippines</span>
                </div>
                <div class="selected-price" id="selectedPrice">â‚¹52</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-mobile-alt"></i>
                <h2>Get Virtual Number</h2>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
            
            <button id="getNumberBtn" class="btn btn-primary">
                <i class="fas fa-sim-card"></i> Get Virtual Number - <span id="buttonPrice">â‚¹52</span>
            </button>
            
            <div id="numberResult" class="result-area">
                <div class="result-item">
                    <span class="result-label">Request ID:</span>
                    <span id="numberId" class="result-value">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Phone Number:</span>
                    <span id="phoneNumber" class="result-value">-</span>
                </div>
                
                <div class="timer">
                    Time Left: <span id="countdown">15:00</span>
                </div>
                
                <div class="action-buttons">
                    <button id="refreshOtpBtn" class="btn btn-success">
                        <i class="fas fa-sync-alt"></i> Refresh OTP
                    </button>
                    <button id="cancelNumberBtn" class="btn btn-danger">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </div>
            
            <div id="otpResult" class="result-area">
                <div class="result-item">
                    <span class="result-label">OTP Code:</span>
                    <span id="otpCode" class="result-value">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Status:</span>
                    <span id="otpStatus" class="result-value">Waiting for OTP...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpvAAef2kZ_V5NomsN_VkmYRCU-q4ECXA",
            authDomain: "happy-seller-3d85b.firebaseapp.com",
            databaseURL: "https://happy-seller-3d85b-default-rtdb.firebaseio.com",
            projectId: "happy-seller-3d85b",
            storageBucket: "happy-seller-3d85b.firebasestorage.app",
            messagingSenderId: "992869798959",
            appId: "1:992869798959:web:03879929680e45610a62da",
            measurementId: "G-476CG6EE86"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // API Configuration
        const API_DOMAIN = 'https://otpal.vercel.app';
        let API_BASE = `${API_DOMAIN}/api?path=`;
        
        // Global Variables
        let currentId = null;
        let countdownTimer = null;
        let timeLeft = 900;
        let currentUser = null;
        let selectedCountry = 'philippines_51';
        let selectedPrice = 52;

        // Countries Database
        const countries = {
            'india_66': { code: '66', name: 'WhatsApp Indian', country: 'India', price: 140, flag: 'ðŸ‡®ðŸ‡³' },
            'india_115': { code: '115', name: 'WhatsApp Indian', country: 'India', price: 103, flag: 'ðŸ‡®ðŸ‡³' },
            'vietnam_118': { code: '118', name: 'WhatsApp Vietnam', country: 'Vietnam', price: 61, flag: 'ðŸ‡»ðŸ‡³' },
            'southafrica_52': { code: '52', name: 'WhatsApp South Africa', country: 'South Africa', price: 45, flag: 'ðŸ‡¿ðŸ‡¦' },
            'colombia_53': { code: '53', name: 'WhatsApp Colombia', country: 'Colombia', price: 71, flag: 'ðŸ‡¨ðŸ‡´' },
            'philippines_51': { code: '51', name: 'WhatsApp Philippines', country: 'Philippines', price: 52, flag: 'ðŸ‡µðŸ‡­' },
            'philippines2_117': { code: '117', name: 'WhatsApp Philippines 2', country: 'Philippines', price: 64, flag: 'ðŸ‡µðŸ‡­' }
        };

        // DOM Elements
        const getNumberBtn = document.getElementById('getNumberBtn');
        const refreshOtpBtn = document.getElementById('refreshOtpBtn');
        const cancelNumberBtn = document.getElementById('cancelNumberBtn');
        const numberResult = document.getElementById('numberResult');
        const otpResult = document.getElementById('otpResult');
        const statusMessage = document.getElementById('statusMessage');

        // Firebase Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('authModal').style.display = 'none';
                setupWalletListener(user.uid);
            } else {
                currentUser = null;
                document.getElementById('authModal').style.display = 'flex';
            }
        });

        // Wallet Listener
        function setupWalletListener(uid) {
            database.ref('users/' + uid + '/wallet').on('value', (snapshot) => {
                const balance = snapshot.val() || 0;
                document.getElementById('profileBalance').textContent = balance;
            });
        }

        // Auth Functions
        async function signUp() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await database.ref('users/' + user.uid).set({
                    email: user.email,
                    wallet: 1000, // Starting balance
                    joined: Date.now()
                });
                
                showAuthStatus('Account created successfully!', 'success');
            } catch (error) {
                showAuthStatus('Error: ' + error.message, 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAuthStatus('Login successful!', 'success');
            } catch (error) {
                showAuthStatus('Error: ' + error.message, 'error');
            }
        }

        function showAuthStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.background = type === 'success' ? 'rgba(0,255,157,0.2)' : 'rgba(255,0,64,0.2)';
            statusEl.style.color = type === 'success' ? 'var(--success)' : 'var(--danger)';
        }

        // Balance Management
        async function deductBalance(amount) {
            try {
                const userRef = database.ref('users/' + currentUser.uid + '/wallet');
                await userRef.transaction((currentBalance) => {
                    return (currentBalance || 0) - amount;
                });
                return true;
            } catch (error) {
                console.error('Deduction failed:', error);
                return false;
            }
        }

        // API Functions
        async function getNumber() {
            if (!currentUser) {
                showStatus('Please login first', 'error');
                return;
            }

            // Check balance
            const balanceSnapshot = await database.ref('users/' + currentUser.uid + '/wallet').once('value');
            const balance = balanceSnapshot.val() || 0;
            
            if (balance < selectedPrice) {
                showStatus(`Insufficient balance! Required: â‚¹${selectedPrice}`, 'error');
                return;
            }

            getNumberBtn.innerHTML = '<div class="loader"></div> Getting Number...';
            getNumberBtn.disabled = true;
            
            try {
                // Deduct balance first
                const deductionSuccess = await deductBalance(selectedPrice);
                if (!deductionSuccess) {
                    showStatus('Payment failed', 'error');
                    return;
                }

                // Call backend API with user ID
                const response = await fetch(`${API_BASE}getNumber&countryKey=${selectedCountry}&ownid=${currentUser.uid}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('numberId').textContent = data.id;
                    document.getElementById('phoneNumber').textContent = data.number;
                    numberResult.classList.add('active');
                    otpResult.classList.add('active');
                    
                    currentId = data.id;
                    startCountdown();
                    
                    showStatus(`Number obtained! â‚¹${selectedPrice} deducted`, 'success');
                } else {
                    // Refund if failed
                    await database.ref('users/' + currentUser.uid + '/wallet').transaction((currentBalance) => {
                        return (currentBalance || 0) + selectedPrice;
                    });
                    showStatus('Failed: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Network error', 'error');
            } finally {
                getNumberBtn.innerHTML = `<i class="fas fa-sim-card"></i> Get Virtual Number - â‚¹${selectedPrice}`;
                getNumberBtn.disabled = false;
            }
        }

        async function getOtp() {
            if (!currentId) {
                showStatus('Please get a number first', 'error');
                return;
            }

            refreshOtpBtn.innerHTML = '<div class="loader"></div> Checking...';
            
            try {
                const response = await fetch(`${API_BASE}getOtp&id=${currentId}&ownid=${currentUser.uid}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.includes('STATUS_OK:CODE:')) {
                        const otpCode = data.data.split(':')[2];
                        document.getElementById('otpCode').textContent = otpCode;
                        document.getElementById('otpStatus').textContent = 'OTP Received!';
                        showStatus('OTP received successfully!', 'success');
                    } else {
                        document.getElementById('otpStatus').textContent = 'Waiting for OTP...';
                    }
                }
            } catch (error) {
                showStatus('Failed to check OTP', 'error');
            } finally {
                refreshOtpBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh OTP';
            }
        }

        async function cancelNumber() {
            if (!currentId) {
                showStatus('No active number', 'error');
                return;
            }

            cancelNumberBtn.innerHTML = '<div class="loader"></div> Cancelling...';
            
            try {
                const response = await fetch(`${API_BASE}cancelNumber&id=${currentId}&ownid=${currentUser.uid}`);
                const data = await response.json();
                
                if (data.success) {
                    // Refund amount
                    await database.ref('users/' + currentUser.uid + '/wallet').transaction((currentBalance) => {
                        return (currentBalance || 0) + selectedPrice;
                    });
                    
                    resetUI();
                    showStatus('Number cancelled & amount refunded', 'success');
                }
            } catch (error) {
                showStatus('Failed to cancel', 'error');
            } finally {
                cancelNumberBtn.innerHTML = '<i class="fas fa-times-circle"></i> Cancel';
            }
        }

        // Timer Functions
        function startCountdown() {
            timeLeft = 900;
            updateCountdownDisplay();
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                updateCountdownDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('countdown').textContent = 'Time Expired!';
                    autoCancelNumber();
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('countdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        async function autoCancelNumber() {
            if (!currentId) return;
            
            try {
                await fetch(`${API_BASE}cancelNumber&id=${currentId}&ownid=${currentUser.uid}`);
                // Auto refund handled by frontend
            } catch (error) {
                console.error('Auto cancel failed:', error);
            }
        }

        function resetUI() {
            numberResult.classList.remove('active');
            otpResult.classList.remove('active');
            document.getElementById('numberId').textContent = '-';
            document.getElementById('phoneNumber').textContent = '-';
            document.getElementById('otpCode').textContent = '-';
            document.getElementById('otpStatus').textContent = 'Waiting for OTP...';
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            currentId = null;
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            statusMessage.classList.add(type === 'success' ? 'status-success' : 'status-error');
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        // Event Listeners
        document.getElementById('signUpBtn').addEventListener('click', signUp);
        document.getElementById('signInBtn').addEventListener('click', signIn);
        document.getElementById('logoutProfileBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('profileBtn').addEventListener('click', () => {
            document.getElementById('profileDropdown').classList.toggle('active');
        });

        getNumberBtn.addEventListener('click', getNumber);
        refreshOtpBtn.addEventListener('click', getOtp);
        cancelNumberBtn.addEventListener('click', cancelNumber);

        // Initialize
        window.addEventListener('load', function() {
            // Set default country
            const countryConfig = countries[selectedCountry];
            document.getElementById('selectedFlag').textContent = countryConfig.flag;
            document.getElementById('selectedName').textContent = countryConfig.name;
            document.getElementById('selectedPrice').textContent = `â‚¹${countryConfig.price}`;
            document.getElementById('buttonPrice').textContent = `â‚¹${countryConfig.price}`;
        });
    </script>
</body>
</html>
